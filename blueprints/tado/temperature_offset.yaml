blueprint:
  name: "Update Entity Offset with Switch 🔥🌡️"
  description: >
    Updates the temperature offset of a Tado climate entity based on the difference
    to another temperature sensor. Optionally only runs when heating is active and
    writes the calculated offset value to an input_number entity.
  domain: automation
  input:
    sensor_to_monitor:
      name: Zigbee Sensor to Monitor
      description: The temperature sensor whose state will be used to update the offset
      selector:
        entity:
          domain:
            - sensor
          device_class:
            - temperature
          multiple: false

    entity_to_update:
      name: Tado Entity to Update
      description: The climate entity whose "offset" attribute will be updated
      selector:
        entity:
          domain:
            - climate
          multiple: false

    threshold:
      name: Threshold
      description: The maximum difference between the two sensors to trigger the automation
      selector:
        number:
          min: 0.0
          max: 10.0
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

    time_interval_minutes:
      name: Time Interval (minutes)
      description: The interval in minutes for the calibration to trigger
      default: 15
      selector:
        number:
          min: 10
          max: 60
          unit_of_measurement: "minutes"

    enable_switch:
      name: Enable Automation only when Heating
      description: >
        When enabled, the automation only runs if the climate entity is currently
        in heating mode.
      default: true
      selector:
        boolean: {}

    offset_output:
      name: Input Number to Store Calculated Offset
      description: >
        Optional input_number entity that will be updated with the calculated
        temperature offset value (named after the selected Tado entity).
      default: ""
      selector:
        entity:
          domain: input_number
          multiple: false

  source_url: https://github.com/matthiasschabhuettl/homeassistant-blueprints/blob/main/blueprints/tado/temperature_offset.yaml

variables:
  entity_to_update: !input entity_to_update
  sensor_to_monitor: !input sensor_to_monitor
  interval: !input time_interval_minutes
  enable_switch: !input enable_switch
  threshold: !input threshold
  offset_output: !input offset_output
  tado_name: "{{ state_attr(entity_to_update, 'friendly_name') or entity_to_update }}"

trigger:
  - platform: time_pattern
    minutes: "*"

condition:
  - condition: template
    value_template: >
      {{ (now().minute % (interval | int)) == 0 }}
  - condition: or
    conditions:
      - condition: template
        value_template: "{{ enable_switch == false }}"
      - condition: and
        conditions:
          - condition: template
            value_template: "{{ enable_switch == true }}"
          - condition: state
            entity_id: !input entity_to_update
            attribute: hvac_action
            state: heating

action:
  - variables:
      calculated_offset: >
        {{
          (states(sensor_to_monitor)|float(0)
          - state_attr(entity_to_update, 'current_temperature')|float(0))
          | round(2)
        }}
  - if:
      - condition: template
        value_template: >
          {{ calculated_offset | abs > (threshold | float(0)) }}
    then:
      - service: tado.set_climate_temperature_offset
        data:
          offset: >
            {{
              (
                (state_attr(entity_to_update, 'offset_celsius') | float(0))
                + calculated_offset
              ) | round(1)
            }}
        target:
          entity_id: !input entity_to_update
      - choose:
          - conditions: "{{ offset_output != '' }}"
            sequence:
              - service: input_number.set_value
                data:
                  entity_id: !input offset_output
                  value: "{{ calculated_offset }}"
              - service: logbook.log
                data:
                  name: "Tado Offset Update"
                  message: >
                    Updated offset for {{ tado_name }} to {{ calculated_offset }} °C
                  entity_id: !input entity_to_update

trace:
  stored_traces: 120
